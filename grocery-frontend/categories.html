<!DOCTYPE html>
<html>
<head>
    <title>Categories</title>
    <link rel="stylesheet" href="./ css/style.css">
</head>
<body>

<div class="container">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <h2 class="logo">ğŸ›’</h2>
        <nav>
            <a class="active">ğŸ  Home</a>
            <a href="./categories.html">ğŸ“‚ Categories</a>
            <a href="./search.html">ğŸ” Search</a>
            <a href = "./user-orders.html">â¤ï¸ Orders</a>
            <a href="./cart.html">ğŸ›ï¸ Cart</a>
            <a href="./ai-chat.html">ğŸ¤– AI Recipes</a>

        </nav>
    </aside>
    

    <!-- MAIN -->
    <main class="main">
        <h1>ğŸ“‚ Categories</h1>
        <!-- SEARCH BOX -->
<div class="search-box">
    <input 
        type="text" 
        id="searchInput"
        placeholder="ğŸ” Search products or category..."
        oninput="searchProducts()"
    />
</div>


        <!-- CATEGORY BUTTONS -->
        <div class="category-buttons">
            <button class="cat-btn active" data-cat="All" onclick="loadCategory('All', this)">ğŸ“¦ All</button>
            <button class="cat-btn" data-cat="Fruits" onclick="loadCategory('Fruits', this)">ğŸ Fruits</button>
            <button class="cat-btn" data-cat="Vegetables" onclick="loadCategory('Vegetables', this)">ğŸ¥• Vegetables</button>
            <button class="cat-btn" data-cat="Dairy" onclick="loadCategory('Dairy', this)">ğŸ¥› Dairy</button>
            <button class="cat-btn" data-cat="Bakery" onclick="loadCategory('Bakery', this)">ğŸ Bakery</button>
            <!-- <button class="cat-btn" data-cat="Snacks" onclick="loadCategory('Snacks', this)">ğŸ« Snacks</button> -->
</div>


        <!-- PRODUCTS -->
        <div id="products" class="product-grid"></div>
    </main>

</div>


<script>
let allProducts = [];
let currentCategory = "All";

function loadCategory(category, btn) {

    // ğŸ”„ reset all category buttons
    document.querySelectorAll(".cat-btn").forEach(b => 
        b.classList.remove("active")
    );

    // âœ… highlight selected button
    if (btn) btn.classList.add("active");

    const url = category === "All"
        ? "http://localhost:8080/products/all"
        : `http://localhost:8080/products/category/${category}`;

    fetch(url)
        .then(res => res.json())
        .then(products => {
            allProductsCache = products;

            const container = document.getElementById("products");
            container.innerHTML = "";

            if (!products || products.length === 0) {
                container.innerHTML = "<p>No products found</p>";
                return;
            }
            

            products.forEach(p => {
                const out = p.stock === 0;

                container.innerHTML += `
                    <div class="product-card">
                        <img src="${p.imageUrl}" alt="${p.name}">
                        <h3>${p.name}</h3>
                        <p>â‚¹${p.price}</p>
                        
                        <p class="stock">
                            Stock: <b>${p.stock}</b>
                        </p>
                        


                        <button class="add-to-cart-btn"
                            ${out ? "disabled" : ""}
                            onclick="addToCart(${p.id})">
                            ${out ? "Out of Stock" : "Add to Cart"}
                        </button>

                    </div>
                `;
            });
        });
}

// Load All by default
window.onload = () => {
    loadCategory("All", document.querySelector(".cat-btn"));
};

function addToCart(productId) {

    // ğŸ” CHECK LOGIN
    const loggedIn = localStorage.getItem("loggedIn");
    if (!loggedIn) {
        alert("Please login to add items to cart");
        window.location.href = "./auth/user-login.html";
        return;
    }

    let cart = JSON.parse(localStorage.getItem("cart")) || [];

    fetch("http://localhost:8080/products/all")
        .then(res => res.json())
        .then(products => {

            // const product = products.find(p => p.id === productId);

            // if (!product || product.stock === 0) {
            //     alert("Product out of stock");
            //     return;
            // }
            const productIndex = products.findIndex(p => p.id === productId);
            const product = products[productIndex];

            if (!product || product.stock === 0) {
                alert("âŒ Product out of stock");
                return;
            }

            const existing = cart.find(item => item.id === productId);

            if (existing) {
                existing.quantity += 1;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    imageUrl: product.imageUrl,
                    quantity: 1
                });
            }
            product.stock -= 1;

            localStorage.setItem("cart", JSON.stringify(cart));

            alert("âœ… Added to cart");
            loadCategory(currentCategory, document.querySelector(".cat-btn.active"));
        });
}



function renderProducts(products) {
    const container = document.getElementById("products");
    container.innerHTML = "";

    if (!products || products.length === 0) {
        container.innerHTML = "<p><b>âŒ Item not available</b></p>";
        return;
    }

    products.forEach(p => {
        container.innerHTML += `
            <div class="product-card">
                <img src="${p.imageUrl}" alt="${p.name}">
                <h3>${p.name}</h3>
                <p>â‚¹${p.price}</p>
                <p class="stock">In Stock</p>
                <button class="add-to-cart-btn" onclick="addToCart(${p.id})">
                    Add to Cart
                </button>
            </div>
        `;
    });
}




function searchProducts() {
    const query = document.getElementById("searchInput").value.toLowerCase();

    const filtered = allProductsCache.filter(p =>
        p.name.toLowerCase().includes(query) ||
        (p.category && p.category.toLowerCase().includes(query))
    );

    renderProducts(filtered);
}

</script>



</body>
</html>
