<!DOCTYPE html>
<html>
<head>
    <title>Admin Orders</title>
    <link rel="stylesheet" href="./ css/style.css">

    <style>
        .order-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        }

        .status {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }

        .placed { background: #f1c40f; color: black; }
        .shipped { background: #3498db; color: white; }
        .delivered { background: #2ecc71; color: white; }

        .order-actions {
            margin-top: 15px;
        }

        .order-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            margin-right: 10px;
            color: white;
        }

        .ship { background: #3498db; }
        .deliver { background: #2ecc71; }
    </style>
</head>
<body>

<div class="container">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <h2 class="logo">ðŸ›’ Admin</h2>
        <nav>
            <a href="./admin-dashboard.html">ðŸ“¦ Products</a>
            <a class="active">ðŸ“‘ Orders</a>
            <a onclick="logoutAdmin()" style="cursor:pointer;">ðŸšª Logout</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <main class="main">
        <h1>Orders</h1>
        <div id="ordersContainer"></div>
    </main>

</div>

<script>
/* ðŸ” ADMIN PROTECTION */
if (localStorage.getItem("loggedIn") !== "admin") {
    alert("Admin access only");
    window.location.href = "../index.html";
}

/* LOAD ORDERS */
fetch("http://localhost:8080/orders/all")
    .then(res => res.json())
    .then(orders => {
        const container = document.getElementById("ordersContainer");
        container.innerHTML = "";

        if (!orders || orders.length === 0) {
            container.innerHTML = "<p>No orders found.</p>";
            return;
        }

        orders.forEach(order => {

            // âœ… SAFE PARSE ITEMS
                let items = [];

                try {
                    let parsed = JSON.parse(order.items);

                    // ðŸ”‘ HANDLE DOUBLE STRINGIFIED JSON
                    if (typeof parsed === "string") {
                        parsed = JSON.parse(parsed);
                    }

                    // ðŸ”’ ensure array
                    items = Array.isArray(parsed) ? parsed : [];
                } catch (e) {
                    console.error("Invalid items JSON:", order.items);
                    items = [];
                }


                // âœ… NOW this is safe
                let itemsHtml = "";
                items.forEach(i => {
                    itemsHtml += `<li>${i.name || "Item"} Ã— ${i.quantity || 1}</li>`;
                });


            container.innerHTML += `
                <div class="order-card">
                    <h3>Order #${order.id}</h3>
                    <p><b>User:</b> ${order.userName || "N/A"}</p>
                    <p><b>Name:</b> ${order.name || "N/A"}</p>
                    <p><b>Phone:</b> ${order.phone}</p>
                    <p><b>Address:</b> ${order.address}</p>
                    <p><b>Payment:</b> ${order.paymentMethod}</p>

                    <p>
                        <b>Status:</b>
                        <span class="status ${order.status?.toLowerCase() || 'placed'}">
                            ${order.status || "PLACED"}
                        </span>
                    </p>

                    <b>Items:</b>
                    <ul>${itemsHtml}</ul>

                    <div class="order-actions">
                        <button class="ship" onclick="updateStatus(${order.id}, 'SHIPPED')">
                            Ship
                        </button>
                        <button class="deliver" onclick="updateStatus(${order.id}, 'DELIVERED')">
                            Deliver
                        </button>
                    </div>
                </div>
            `;
        });
    })
    .catch(err => {
        console.error(err);
        alert("Failed to load orders");
    });

/* UPDATE STATUS */
function updateStatus(id, status) {
    fetch(`http://localhost:8080/orders/${id}/status?status=${status}`, {
        method: "PUT"
    })
    .then(() => {
        alert("Order status updated");
        location.reload();
    });
}

function logoutAdmin() {
    localStorage.removeItem("loggedIn");
    window.location.href = "./index.html";
}
</script>

</body>
</html>
